/**
 * Flagging module for question reports.
 *
 * @module     local_questions/flagging
 * @copyright  2026 Sergio C.
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */define(["jquery","core/ajax","core/notification","core/str"],function(t,r,i,u){let s=0,n={};const m=function(e){require(["theme_remui/gamification_toast"],function(o){o&&typeof o.show=="function"?o.show(e):c(e)},function(){c(e)})},c=function(e){i.addNotification({message:e.title+": "+e.message,type:"success"})},g=function(){u.get_strings([{key:"alreadyflagged",component:"local_questions"},{key:"flagsubmitted",component:"local_questions"},{key:"flagsubmitted_desc",component:"local_questions"}]).done(function(e){n.alreadyflagged=e[0],n.flagsubmitted=e[1],n.flagsubmitted_desc=e[2]})},p=function(e){const o=document.getElementById(e);typeof bootstrap<"u"&&bootstrap.Modal?bootstrap.Modal.getOrCreateInstance(o).show():t("#"+e).modal("show")},d=function(e){const o=document.getElementById(e);if(typeof bootstrap<"u"&&bootstrap.Modal){const a=bootstrap.Modal.getInstance(o);a&&a.hide()}else t("#"+e).modal("hide")},b=function(){g(),t(document).on("click",".local-questions-flag-btn:not(.disabled)",function(e){e.preventDefault(),s=t(this).data("questionid"),t("#flag-questionid").val(s),f(),p("local-questions-flag-modal")}),t(document).on("click","#confirm-flag-btn",function(e){e.preventDefault(),v()}),t(document).on("click","#submit-flag-btn",function(e){e.preventDefault(),h()}),t(document).on("click",'#local-questions-flag-modal [data-bs-dismiss="modal"]',function(e){e.preventDefault(),d("local-questions-flag-modal")}),t("#local-questions-flag-modal").on("hidden.bs.modal",function(){f()})},f=function(){t("#flag-step-confirm").removeClass("d-none"),t("#flag-step-form").addClass("d-none"),t("#flag-reason").val("").removeClass("is-invalid"),t("#flag-comment").val(""),t("#flag-error-message").addClass("d-none"),t("#submit-flag-btn").prop("disabled",!1)},v=function(){t("#flag-step-confirm").addClass("d-none"),t("#flag-step-form").removeClass("d-none")},h=function(){const e=t("#flag-reason").val(),o=t("#flag-comment").val().trim();if(!e){t("#flag-reason").addClass("is-invalid");return}t("#flag-reason").removeClass("is-invalid"),t("#submit-flag-btn").prop("disabled",!0);const a=new URLSearchParams(window.location.search),y=parseInt(a.get("attempt"))||0;r.call([{methodname:"local_questions_submit_flag",args:{questionid:s,reason:e,comment:o,attemptid:y}}])[0].done(function(l){l.success?(d("local-questions-flag-modal"),m({type:"info",title:n.flagsubmitted||"\xA1Reporte enviado!",message:n.flagsubmitted_desc||"Gracias por ayudarnos a mejorar.",category:"success",duration:4e3,sound:!1}),q(s)):(t("#flag-error-text").text(l.message),t("#flag-error-message").removeClass("d-none"),t("#submit-flag-btn").prop("disabled",!1))}).fail(function(l){i.exception(l),t("#submit-flag-btn").prop("disabled",!1)})},q=function(e){const o=t('.local-questions-flag-btn[data-questionid="'+e+'"]'),a=n.alreadyflagged||"Ya reportada";o.removeClass("btn-outline-danger").addClass("btn-secondary disabled").prop("disabled",!0).attr("title",a).html('<i class="fa fa-check-circle"></i> <span class="ms-1">'+a+"</span>")};return{init:b}});
