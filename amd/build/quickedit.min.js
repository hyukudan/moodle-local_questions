// Minified by local_questions build script.
(()=>{define(["jquery","core/ajax","core/str","core/notification"],function(e,d,q,c){return{init:function(){var u=e("#questions-table");u.on("input",".inplace-edit",function(){e(this).closest("tr").find(".save-row").show(),e("#batch-save-btn").show()}),u.on("click",".save-row",function(){var t=e(this),a=t.closest("tr"),i=a.data("id"),s=[];t.prop("disabled",!0);var l=a.find('[data-field="questiontext"]');l.length&&s.push({methodname:"local_questions_save_question_field",args:{questionid:i,field:"questiontext",value:l.text()}}),a.find("[data-answerid]").each(function(){var n=e(this),o=n.data("field"),p=n.data("answerid"),g=n.text();s.push({methodname:"local_questions_save_question_field",args:{questionid:i,field:o+":"+p,value:g}})}),s.length?e.when.apply(e,d.call(s)).then(function(){t.hide().prop("disabled",!1),e(".save-row:visible").length===0&&e("#batch-save-btn").hide()}).fail(function(n){t.prop("disabled",!1),c.exception(n)}):t.hide().prop("disabled",!1)}),e("#batch-save-btn").click(function(){var t=[];u.find(".save-row:visible").each(function(){var a=e(this).closest("tr"),i=a.data("id"),s=a.find('[data-field="questiontext"]');t.push({methodname:"local_questions_save_question_field",args:{questionid:i,field:"questiontext",value:s.text()}}),a.find("[data-answerid]").each(function(){var l=e(this);t.push({methodname:"local_questions_save_question_field",args:{questionid:i,field:l.data("field")+":"+l.data("answerid"),value:l.text()}})})}),t.length&&e.when.apply(e,d.call(t)).then(function(){e(".save-row").hide(),e("#batch-save-btn").hide(),c.addNotification({message:"Batch save successful",type:"success"})}).fail(c.exception)});var r=e("#select-all-questions"),h=e(".question-checkbox"),f=e("#batch-analyze-btn");function v(){var t=e(".question-checkbox:checked").length;f.prop("disabled",t===0)}r.change(function(){h.prop("checked",this.checked),v()}),u.on("change",".question-checkbox",function(){v(),r.prop("checked",e(".question-checkbox:checked").length===h.length)}),f.click(function(){var t=[];if(e(".question-checkbox:checked").each(function(){t.push(e(this).val())}),t.length!==0){var a=e("#ai-review-modal");a.modal("show"),e("#ai-loading").show(),e("#ai-results").hide(),e("#ai-error").hide(),e("#ai-suggestions-list").empty(),e("#ai-apply-all").hide(),d.call([{methodname:"local_questions_analyze_batch",args:{questionids:t}}])[0].then(function(i){if(e("#ai-loading").hide(),i.status==="error"){e("#ai-error").text(i.message).show();return}var s=JSON.parse(i.dataset);s.questions&&s.questions.length>0?(e("#ai-results").show(),e("#ai-apply-all").show(),require(["core/templates"],function(l){s.questions.forEach(function(n){!n.suggestions||n.suggestions.length===0||(n.issueCount=n.issues.length,l.render("local_questions/ai_suggestion_card",n).then(function(o){e("#ai-suggestions-list").append(o)}))})})):e("#ai-results").show().html('<div class="alert alert-success">No issues found by AI!</div>')}).fail(function(i){e("#ai-loading").hide(),e("#ai-error").text(i.message).show()})}}),e("body").on("click",".btn-apply-change",function(){var t=e(this),a=t.closest("tr"),i=a.data("qid"),s=a.data("field"),l=a.find(".text-success").text();t.prop("disabled",!0).text("Applying..."),d.call([{methodname:"local_questions_save_question_field",args:{questionid:i,field:s,value:l}}])[0].then(function(){t.removeClass("btn-outline-success").addClass("btn-success").text("Applied"),a.find(".text-danger").css("text-decoration","line-through");var n=e('#questions-table tr[data-id="'+i+'"]');if(s==="questiontext")n.find('[data-field="questiontext"]').text(l);else{var o=s.split(":");o.length===2&&n.find('[data-field="'+o[0]+'"][data-answerid="'+o[1]+'"]').text(l)}}).fail(c.exception)}),e("#ai-apply-all").click(function(){e(".btn-apply-change:visible:not(:disabled)").click()})}}});})();
