// Minified by local_questions build script.
(()=>{/**
 * Flag review module for teachers/reviewers.
 *
 * @module     local_questions/flag_review
 * @copyright  2026 Sergio C.
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */define(["jquery","core/ajax","core/notification","core/str"],function(e,d,r,m){let a={};const f=function(){g(),e(document).on("click",".filter-btn",function(t){t.preventDefault();const s=e(this).data("filter");b(s)}),e(document).on("click",".view-details-btn",function(t){t.preventDefault();const s=e(this).data("questionid");p(s)}),e(document).on("click",".edit-question-btn",function(t){t.preventDefault();const s=e(this).data("questionid");x(s)}),e(document).on("click",".resolve-btn",function(t){t.preventDefault();const s=e(this).data("questionid");c(s,"resolve")}),e(document).on("click",".dismiss-btn",function(t){t.preventDefault();const s=e(this).data("questionid");c(s,"dismiss")}),e(document).on("click","#submit-resolution-btn",function(t){t.preventDefault(),y()}),e("#flag-resolution-modal").on("hidden.bs.modal",function(){u()})},g=function(){m.get_strings([{key:"resolve",component:"local_questions"},{key:"dismiss",component:"local_questions"},{key:"resolving",component:"local_questions"},{key:"dismissing",component:"local_questions"},{key:"nocomment",component:"local_questions"}]).done(function(t){a.resolve=t[0],a.dismiss=t[1],a.resolving=t[2],a.dismissing=t[3],a.nocomment=t[4]})},b=function(t){e(".filter-btn").removeClass("active"),e('.filter-btn[data-filter="'+t+'"]').addClass("active"),t==="all"?e("#flags-table tbody tr").show():(e("#flags-table tbody tr").hide(),e('#flags-table tbody tr[data-status="'+t+'"]').show())},p=function(t){e("#flag-details-loading").removeClass("d-none"),e("#flag-details-content").addClass("d-none");const s=document.getElementById("flag-details-modal"),o=bootstrap.Modal.getOrCreateInstance(s);o.show(),d.call([{methodname:"local_questions_get_flag_details",args:{questionid:t}}])[0].done(function(i){v(i)}).fail(function(i){r.exception(i),o.hide()})},v=function(t){e("#detail-questionid").text("#"+t.questionid),e("#detail-questionname").text(t.questionname),e("#detail-questiontext").text(h(t.questiontext)),e("#detail-flagcount").text(t.flagcount);let s=q(t.status);e("#detail-status-badge").html(s),t.status==="resolved"||t.status==="dismissed"?(e("#detail-resolution-info").removeClass("d-none"),e("#detail-resolution-text").text(t.resolution),e("#detail-resolution-feedback").text(t.resolutionfeedback)):e("#detail-resolution-info").addClass("d-none");const o=e("#detail-flags-list").empty(),i=document.getElementById("flag-item-template");t.flags.forEach(function(n){const l=e(i.content.cloneNode(!0));l.find(".flag-reason").text(n.reason_label),l.find(".flag-date").text(k(n.timecreated)),l.find(".flag-user").text(n.username),l.find(".flag-comment").text(n.comment||a.nocomment||"(Sin comentario)"),o.append(l)}),e("#flag-details-loading").addClass("d-none"),e("#flag-details-content").removeClass("d-none")},q=function(t){return{pending:'<span class="badge bg-warning text-dark">Pendiente</span>',reviewing:'<span class="badge bg-info">En revisi\xF3n</span>',resolved:'<span class="badge bg-success">Resuelta</span>',dismissed:'<span class="badge bg-dark">Descartada</span>'}[t]||'<span class="badge bg-secondary">'+C(t)+"</span>"},h=function(t){return t?String(t).replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').trim():""},C=function(t){if(!t)return"";const s={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(t).replace(/[&<>"']/g,function(o){return s[o]})},k=function(t){const s=new Date(t*1e3);return s.toLocaleDateString()+" "+s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},x=function(t){const s=M.cfg.wwwroot+"/question/bank/editquestion/question.php?id="+t;window.open(s,"_blank")},c=function(t,s){e("#resolution-questionid").val(t),e("#resolution-action").val(s);const o=e("#resolution-modal-header"),i=e("#submit-resolution-btn"),n=e("#resolution-type-group");s==="resolve"?(o.removeClass("bg-danger").addClass("bg-success"),e("#flag-resolution-title").html('<i class="fa fa-check mr-2"></i>'+(a.resolve||"Resolver")),i.removeClass("btn-danger").addClass("btn-success").text(a.resolve||"Resolver"),n.show()):(o.removeClass("bg-success").addClass("bg-danger"),e("#flag-resolution-title").html('<i class="fa fa-times mr-2"></i>'+(a.dismiss||"Descartar")),i.removeClass("btn-success").addClass("btn-danger").text(a.dismiss||"Descartar"),n.hide()),u();const l=document.getElementById("flag-resolution-modal");bootstrap.Modal.getOrCreateInstance(l).show()},u=function(){e("#resolution-type").val(""),e("#resolution-feedback").val(""),e("#resolution-success-message").addClass("d-none"),e("#resolution-error-message").addClass("d-none"),e("#submit-resolution-btn").prop("disabled",!1)},y=function(){const t=e("#resolution-questionid").val(),s=e("#resolution-action").val(),o=e("#resolution-type").val(),i=e("#resolution-feedback").val().trim();if(s==="resolve"&&!o){e("#resolution-type").addClass("is-invalid");return}if(!i){e("#resolution-feedback").addClass("is-invalid");return}e("#resolution-type, #resolution-feedback").removeClass("is-invalid"),e("#submit-resolution-btn").prop("disabled",!0),d.call([{methodname:"local_questions_update_flag_status",args:{questionid:parseInt(t),action:s,resolution:o,feedback:i}}])[0].done(function(n){n.success?(e("#resolution-success-text").text(n.message),e("#resolution-success-message").removeClass("d-none"),setTimeout(function(){window.location.reload()},1500)):(e("#resolution-error-text").text(n.message),e("#resolution-error-message").removeClass("d-none"),e("#submit-resolution-btn").prop("disabled",!1))}).fail(function(n){r.exception(n),e("#submit-resolution-btn").prop("disabled",!1)})};return{init:f}});})();
