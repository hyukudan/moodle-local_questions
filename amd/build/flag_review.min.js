// Minified by local_questions build script.
(()=>{/**
 * Flag review module for teachers/reviewers.
 *
 * @module     local_questions/flag_review
 * @copyright  2026 Sergio C.
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */define(["jquery","core/ajax","core/notification","core/str"],function(e,c,r,m){let i={};const g=function(){b(),e(document).on("click",".filter-btn",function(t){t.preventDefault();const s=e(this).data("filter");p(s)}),e(document).on("click",".view-details-btn",function(t){t.preventDefault();const s=e(this).data("questionid");v(s)}),e(document).on("click",".edit-question-btn",function(t){t.preventDefault();const s=e(this).data("questionid");x(s)}),e(document).on("click",".resolve-btn",function(t){t.preventDefault();const s=e(this).data("questionid");u(s,"resolve")}),e(document).on("click",".dismiss-btn",function(t){t.preventDefault();const s=e(this).data("questionid");u(s,"dismiss")}),e(document).on("click","#submit-resolution-btn",function(t){t.preventDefault(),y()}),e("#flag-resolution-modal").on("hidden.bs.modal",function(){f()}),e(document).on("click","#flag-details-modal .close-modal-btn",function(){d("flag-details-modal","hide")})},b=function(){m.get_strings([{key:"resolve",component:"local_questions"},{key:"dismiss",component:"local_questions"},{key:"resolving",component:"local_questions"},{key:"dismissing",component:"local_questions"},{key:"nocomment",component:"local_questions"}]).done(function(t){i.resolve=t[0],i.dismiss=t[1],i.resolving=t[2],i.dismissing=t[3],i.nocomment=t[4]})},p=function(t){e(".filter-btn").removeClass("active"),e('.filter-btn[data-filter="'+t+'"]').addClass("active"),t==="all"?e("#flags-table tbody tr").show():(e("#flags-table tbody tr").hide(),e('#flags-table tbody tr[data-status="'+t+'"]').show())},d=function(t,s){const o=document.getElementById(t);typeof window.bootstrap<"u"&&window.bootstrap.Modal?window.bootstrap.Modal.getOrCreateInstance(o)[s]():e("#"+t).modal(s)},v=function(t){e("#flag-details-loading").removeClass("d-none"),e("#flag-details-content").addClass("d-none"),d("flag-details-modal","show"),c.call([{methodname:"local_questions_get_flag_details",args:{questionid:t}}])[0].done(function(s){q(s)}).fail(function(s){r.exception(s),d("flag-details-modal","hide")})},q=function(t){e("#detail-questionid").text("#"+t.questionid),e("#detail-questionname").text(t.questionname),e("#detail-questiontext").text(k(t.questiontext)),e("#detail-flagcount").text(t.flagcount);let s=h(t.status);e("#detail-status-badge").html(s),t.status==="resolved"||t.status==="dismissed"?(e("#detail-resolution-info").removeClass("d-none"),e("#detail-resolution-text").text(t.resolution),e("#detail-resolution-feedback").text(t.resolutionfeedback)):e("#detail-resolution-info").addClass("d-none");const o=e("#detail-flags-list").empty(),a=document.getElementById("flag-item-template");t.flags.forEach(function(n){const l=e(a.content.cloneNode(!0));l.find(".flag-reason").text(n.reason_label),l.find(".flag-date").text(w(n.timecreated)),l.find(".flag-user").text(n.username),l.find(".flag-comment").text(n.comment||i.nocomment||"(Sin comentario)"),o.append(l)}),e("#flag-details-loading").addClass("d-none"),e("#flag-details-content").removeClass("d-none")},h=function(t){return{pending:'<span class="badge bg-warning text-dark">Pendiente</span>',reviewing:'<span class="badge bg-info">En revisi\xF3n</span>',resolved:'<span class="badge bg-success">Resuelta</span>',dismissed:'<span class="badge bg-dark">Descartada</span>'}[t]||'<span class="badge bg-secondary">'+C(t)+"</span>"},k=function(t){return t?String(t).replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').trim():""},C=function(t){if(!t)return"";const s={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(t).replace(/[&<>"']/g,function(o){return s[o]})},w=function(t){const s=new Date(t*1e3);return s.toLocaleDateString()+" "+s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},x=function(t){const s=M.cfg.wwwroot+"/local/questions/index.php?tab=questions";window.open(s,"_blank")},u=function(t,s){e("#resolution-questionid").val(t),e("#resolution-action").val(s);const o=e("#resolution-modal-header"),a=e("#submit-resolution-btn"),n=e("#resolution-type-group");s==="resolve"?(o.removeClass("bg-danger").addClass("bg-success"),e("#flag-resolution-title").html('<i class="fa fa-check mr-2"></i>'+(i.resolve||"Resolver")),a.removeClass("btn-danger").addClass("btn-success").text(i.resolve||"Resolver"),n.show()):(o.removeClass("bg-success").addClass("bg-danger"),e("#flag-resolution-title").html('<i class="fa fa-times mr-2"></i>'+(i.dismiss||"Descartar")),a.removeClass("btn-success").addClass("btn-danger").text(i.dismiss||"Descartar"),n.hide()),f(),d("flag-resolution-modal","show")},f=function(){e("#resolution-type").val(""),e("#resolution-feedback").val(""),e("#resolution-success-message").addClass("d-none"),e("#resolution-error-message").addClass("d-none"),e("#submit-resolution-btn").prop("disabled",!1)},y=function(){const t=e("#resolution-questionid").val(),s=e("#resolution-action").val(),o=e("#resolution-type").val(),a=e("#resolution-feedback").val().trim();if(s==="resolve"&&!o){e("#resolution-type").addClass("is-invalid");return}if(!a){e("#resolution-feedback").addClass("is-invalid");return}e("#resolution-type, #resolution-feedback").removeClass("is-invalid"),e("#submit-resolution-btn").prop("disabled",!0),c.call([{methodname:"local_questions_update_flag_status",args:{questionid:parseInt(t),action:s,resolution:o,feedback:a}}])[0].done(function(n){n.success?(e("#resolution-success-text").text(n.message),e("#resolution-success-message").removeClass("d-none"),setTimeout(function(){window.location.reload()},1500)):(e("#resolution-error-text").text(n.message),e("#resolution-error-message").removeClass("d-none"),e("#submit-resolution-btn").prop("disabled",!1))}).fail(function(n){r.exception(n),e("#submit-resolution-btn").prop("disabled",!1)})};return{init:g}});})();
