/**
 * Flag review module for teachers/reviewers.
 *
 * @module     local_questions/flag_review
 * @copyright  2026 Sergio C.
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */define(["jquery","core/ajax","core/notification","core/str"],function(e,u,f,q){const m=function(t){require(["theme_remui/gamification_toast"],function(s){s&&typeof s.show=="function"?s.show(t):g(t)},function(){g(t)})},g=function(t){f.addNotification({message:t.title+": "+t.message,type:t.category==="success"?"success":"info"})};let i={};const h=function(){w(),e(document).on("click",".filter-btn",function(t){t.preventDefault();const s=e(this).data("filter");k(s)}),e(document).on("click",".view-details-btn",function(t){t.preventDefault();const s=e(this).data("questionid");_(s)}),e(document).on("click",".edit-question-btn",function(t){t.preventDefault();const s=e(this).data("questionid");D(s)}),e(document).on("click",".resolve-btn",function(t){t.preventDefault();const s=e(this).data("questionid");p(s,"resolve")}),e(document).on("click",".dismiss-btn",function(t){t.preventDefault();const s=e(this).data("questionid");p(s,"dismiss")}),e(document).on("click","#submit-resolution-btn",function(t){t.preventDefault(),F()}),e("#flag-resolution-modal").on("hidden.bs.modal",function(){b()}),e(document).on("click","#flag-details-modal .close-modal-btn",function(){r("flag-details-modal","hide")}),e(document).on("click","#flag-resolution-modal .close-resolution-btn",function(){r("flag-resolution-modal","hide")}),e(document).on("click","#flag-edit-modal .close-edit-btn",function(){r("flag-edit-modal","hide")}),e(document).on("click","#save-edit-btn",function(t){t.preventDefault(),R()})},w=function(){q.get_strings([{key:"resolve",component:"local_questions"},{key:"dismiss",component:"local_questions"},{key:"resolving",component:"local_questions"},{key:"dismissing",component:"local_questions"},{key:"nocomment",component:"local_questions"},{key:"save",component:"core"},{key:"saving",component:"local_questions"},{key:"savechanges",component:"local_questions"},{key:"questionsaved",component:"local_questions"}]).done(function(t){i.resolve=t[0],i.dismiss=t[1],i.resolving=t[2],i.dismissing=t[3],i.nocomment=t[4],i.save=t[5],i.saving=t[6],i.savechanges=t[7],i.questionsaved=t[8]})},k=function(t){e(".filter-btn").removeClass("active"),e('.filter-btn[data-filter="'+t+'"]').addClass("active"),t==="all"?e("#flags-table tbody tr").show():(e("#flags-table tbody tr").hide(),e('#flags-table tbody tr[data-status="'+t+'"]').show())},r=function(t,s){const n=document.getElementById(t);typeof window.bootstrap<"u"&&window.bootstrap.Modal?window.bootstrap.Modal.getOrCreateInstance(n)[s]():e("#"+t).modal(s)},_=function(t){e("#flag-details-loading").removeClass("d-none"),e("#flag-details-content").addClass("d-none"),r("flag-details-modal","show"),u.call([{methodname:"local_questions_get_flag_details",args:{questionid:t}}])[0].done(function(s){x(s)}).fail(function(s){f.exception(s),r("flag-details-modal","hide")})},x=function(t){e("#detail-questionid").text("#"+t.questionid),e("#detail-questionname").text(t.questionname),e("#detail-questiontext").text(c(t.questiontext)),e("#detail-flagcount").text(t.flagcount);let s=y(t.status);e("#detail-status-badge").html(s),t.status==="resolved"||t.status==="dismissed"?(e("#detail-resolution-info").removeClass("d-none"),e("#detail-resolution-text").text(t.resolution),e("#detail-resolution-feedback").text(t.resolutionfeedback)):e("#detail-resolution-info").addClass("d-none");const n=e("#detail-flags-list").empty(),a=document.getElementById("flag-item-template");t.flags.forEach(function(o){const l=e(a.content.cloneNode(!0));l.find(".flag-reason").text(o.reason_label),l.find(".flag-date").text(I(o.timecreated)),l.find(".flag-user").text(o.username),l.find(".flag-comment").text(o.comment||i.nocomment||"(Sin comentario)"),n.append(l)}),e("#flag-details-loading").addClass("d-none"),e("#flag-details-content").removeClass("d-none")},y=function(t){return{pending:'<span class="badge bg-warning text-dark">Pendiente</span>',reviewing:'<span class="badge bg-info">En revisi\xF3n</span>',resolved:'<span class="badge bg-success">Resuelta</span>',dismissed:'<span class="badge bg-dark">Descartada</span>'}[t]||'<span class="badge bg-secondary">'+C(t)+"</span>"},c=function(t){return t?String(t).replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').trim():""},C=function(t){if(!t)return"";const s={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(t).replace(/[&<>"']/g,function(n){return s[n]})},I=function(t){const s=new Date(t*1e3);return s.toLocaleDateString()+" "+s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},D=function(t){e("#edit-loading").removeClass("d-none"),e("#edit-content").addClass("d-none"),e("#edit-success-message, #edit-error-message").addClass("d-none"),e("#save-edit-btn").prop("disabled",!1),r("flag-edit-modal","show"),u.call([{methodname:"local_questions_get_flag_details",args:{questionid:t}}])[0].done(function(s){E(s)}).fail(function(s){f.exception(s),r("flag-edit-modal","hide")})},E=function(t){e("#edit-questionid").val(t.questionid),e("#edit-questionname").text(t.questionname),e("#edit-questiontext").val(c(t.questiontext)),e("#edit-generalfeedback").val(c(t.generalfeedback||""));const s=e("#edit-answers-container").empty(),n=document.getElementById("edit-answer-template"),a=["A","B","C","D","E","F","G","H"];t.answers&&t.answers.length>0&&t.answers.forEach(function(o,l){const d=e(n.content.cloneNode(!0));d.find(".answer-item").attr("data-answerid",o.id),d.find(".answer-label").text(a[l]||l+1),d.find(".correct-answer-radio").val(o.id),o.iscorrect&&d.find(".correct-answer-radio").prop("checked",!0),d.find(".answer-text").val(c(o.answer)),d.find(".answer-feedback").val(c(o.feedback||"")),s.append(d)}),e("#edit-loading").addClass("d-none"),e("#edit-content").removeClass("d-none")},R=function(){const t=e("#edit-questionid").val(),s=e("#edit-questiontext").val().trim(),n=e("#edit-generalfeedback").val().trim();if(!s){e("#edit-questiontext").addClass("is-invalid");return}e("#edit-questiontext").removeClass("is-invalid"),e("#save-edit-btn").prop("disabled",!0).html('<i class="fa fa-spinner fa-spin me-1"></i>'+(i.saving||"Guardando..."));const a=[];a.push({methodname:"local_questions_save_question_field",args:{questionid:parseInt(t),field:"questiontext",value:s}}),a.push({methodname:"local_questions_save_question_field",args:{questionid:parseInt(t),field:"generalfeedback",value:n}});const o=e('input[name="correct-answer"]:checked').val();e("#edit-answers-container .answer-item").each(function(){const d=e(this),v=d.data("answerid"),P=d.find(".answer-text").val().trim(),H=d.find(".answer-feedback").val().trim();a.push({methodname:"local_questions_save_question_field",args:{questionid:parseInt(t),field:"answer:"+v,value:P}}),a.push({methodname:"local_questions_save_question_field",args:{questionid:parseInt(t),field:"feedback:"+v,value:H}})}),o&&a.push({methodname:"local_questions_save_question_field",args:{questionid:parseInt(t),field:"correctanswer",value:o}});const l=u.call(a);e.when.apply(e,l).then(function(){r("flag-edit-modal","hide"),m({type:"info",title:"\u270F\uFE0F Pregunta actualizada",message:i.questionsaved||"Pregunta guardada correctamente.",category:"success",duration:3e3,sound:!1}),B(t,s)}).fail(function(d){e("#edit-error-text").text(d.message||"Error al guardar"),e("#edit-error-message").removeClass("d-none"),e("#save-edit-btn").prop("disabled",!1).html('<i class="fa fa-save me-1"></i>'+(i.savechanges||"Guardar cambios"))})},B=function(t,s){const n=e('#flags-table tbody tr[data-questionid="'+t+'"]');if(n.length){const a=s.length>100?s.substring(0,100)+"...":s;n.find(".text-truncate").text(a)}},p=function(t,s){e("#resolution-questionid").val(t),e("#resolution-action").val(s);const n=e("#resolution-modal-header"),a=e("#submit-resolution-btn"),o=e("#resolution-type-group");s==="resolve"?(n.removeClass("bg-danger text-dark").addClass("bg-success text-white"),e("#flag-resolution-title").html('<i class="fa fa-check me-2"></i>'+(i.resolve||"Resolver")),a.removeClass("btn-danger").addClass("btn-success text-white").text(i.resolve||"Resolver"),o.show()):(n.removeClass("bg-success").addClass("bg-danger text-white"),e("#flag-resolution-title").html('<i class="fa fa-times me-2"></i>'+(i.dismiss||"Descartar")),a.removeClass("btn-success").addClass("btn-danger text-white").text(i.dismiss||"Descartar"),o.hide()),b(),r("flag-resolution-modal","show")},b=function(){e("#resolution-type").val(""),e("#resolution-feedback").val(""),e("#resolution-success-message").addClass("d-none"),e("#resolution-error-message").addClass("d-none"),e("#submit-resolution-btn").prop("disabled",!1)},F=function(){const t=e("#resolution-questionid").val(),s=e("#resolution-action").val(),n=e("#resolution-type").val(),a=e("#resolution-feedback").val().trim();if(s==="resolve"&&!n){e("#resolution-type").addClass("is-invalid");return}if(!a){e("#resolution-feedback").addClass("is-invalid");return}e("#resolution-type, #resolution-feedback").removeClass("is-invalid"),e("#submit-resolution-btn").prop("disabled",!0),u.call([{methodname:"local_questions_update_flag_status",args:{questionid:parseInt(t),action:s,resolution:n,feedback:a}}])[0].done(function(o){o.success?(r("flag-resolution-modal","hide"),m({type:"info",title:s==="resolve"?"\u2705 Reporte resuelto":"\u274C Reporte descartado",message:o.message,category:s==="resolve"?"success":"danger",duration:4e3,sound:!1}),S(t,s)):(e("#resolution-error-text").text(o.message),e("#resolution-error-message").removeClass("d-none"),e("#submit-resolution-btn").prop("disabled",!1))}).fail(function(o){f.exception(o),e("#submit-resolution-btn").prop("disabled",!1)})},S=function(t,s){const n=e('#flags-table tbody tr[data-questionid="'+t+'"]');if(!n.length)return;const a=s==="resolve"?"resolved":"dismissed";n.attr("data-status",a);const o={resolved:'<span class="badge bg-success">Resuelta</span>',dismissed:'<span class="badge bg-dark">Descartada</span>'};n.find("td:eq(4)").html(o[a]),n.find(".resolve-btn, .dismiss-btn").hide(),M(s);const l=e(".filter-btn.active").data("filter");(l==="pending"||l==="reviewing")&&n.fadeOut(300)},M=function(t){const s=e('.filter-btn[data-filter="pending"] .badge');let n=parseInt(s.text())||0;n>0&&(n--,s.text(n));const o=e('.filter-btn[data-filter="'+(t==="resolve"?"resolved":"dismissed")+'"] .badge');let l=parseInt(o.text())||0;l++,o.text(l)};return{init:h}});
